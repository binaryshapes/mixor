name: Release
on:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.filter.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get commit message
        id: get_commit
        run: |
          msg=$(git log -1 --pretty=%B)
          printf '%s\n' "$msg" > commit_message.txt

      - name: Filter commits
        id: filter
        run: |
          msg=$(cat commit_message.txt)
          echo "Commit message: $msg"

          if [[ "$msg" =~ ^(feat|fix|perf|refact|release) ]]; then
            echo "âœ… Matches release-worthy commit"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "â­ï¸  Skipping workflow for this commit"
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  validate:
    needs: filter
    if: needs.filter.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.0

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/deno
          key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
          restore-keys: |
            ${{ runner.os }}-deno-

      - name: ğŸ”§ Run checks
        run: deno task check

      - name: ğŸ’„ Run lint
        run: deno task lint

      - name: ğŸ§ª Run tests
        run: deno task test

  release:
      needs: [filter, validate]
      if: needs.filter.outputs.should_run == 'true'
      runs-on: ubuntu-latest
      outputs:
        release_created: ${{ steps.release_please.outputs.release_created }}
        tag_name: ${{ steps.release_please.outputs.tag_name }}
        upload_url: ${{ steps.release_please.outputs.upload_url }}
      steps:
        - uses: googleapis/release-please-action@v4
          id: release_please
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
            release-type: simple